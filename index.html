<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Delivery Tracker Pro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding-bottom: 80px;
    }
    .header { 
      background: white; 
      padding: 15px 20px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 20px; color: #1f2937; }
    .status { 
      font-size: 11px; 
      padding: 4px 8px; 
      border-radius: 12px;
      font-weight: 600;
    }
    .status.online { background: #d1fae5; color: #065f46; }
    .status.offline { background: #fee2e2; color: #991b1b; }
    .container { max-width: 600px; margin: 20px auto; padding: 0 20px; }
    .card { 
      background: white; 
      border-radius: 16px; 
      padding: 20px; 
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .card h2 { font-size: 18px; margin-bottom: 15px; color: #1f2937; }
    .input-group { margin-bottom: 12px; }
    .input-group label { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      padding: 14px;
      background: #f9fafb;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .input-group label:hover { background: #f3f4f6; }
    .input-group input[type="checkbox"] { 
      width: 22px; 
      height: 22px; 
      cursor: pointer;
    }
    .input-group span { font-size: 15px; font-weight: 500; }
    input[type="date"], input[type="month"], input[type="text"], input[type="number"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      margin-bottom: 10px;
      transition: border 0.2s;
    }
    input:focus { outline: none; border-color: #667eea; }
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-secondary { background: #6b7280; color: white; }
    .summary { 
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin: 15px 0;
    }
    .summary h3 { margin-bottom: 12px; font-size: 16px; }
    .summary .total { font-size: 28px; font-weight: bold; margin-top: 15px; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 14px; }
    th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    th { background: #f3f4f6; font-weight: 600; font-size: 13px; }
    .nav { 
      position: fixed; 
      bottom: 0; 
      left: 0; 
      right: 0; 
      background: white; 
      display: flex; 
      justify-content: space-around;
      padding: 8px 0;
      box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
    }
    .nav button {
      background: none;
      border: none;
      padding: 8px 15px;
      font-size: 13px;
      cursor: pointer;
      color: #6b7280;
      font-weight: 500;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .nav button.active { color: #667eea; background: #eef2ff; }
    .hidden { display: none; }
    .alert { 
      background: #fef3c7; 
      border-left: 4px solid #f59e0b;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      font-size: 13px;
    }
    .alert.success { background: #d1fae5; border-color: #10b981; }
    .alert.error { background: #fee2e2; border-color: #ef4444; }
    .settings-row { 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
    }
    .stats { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 10px; 
      margin: 15px 0;
    }
    .stat-card { 
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    .stat-value { font-size: 24px; font-weight: bold; }
    .stat-label { font-size: 11px; opacity: 0.9; margin-top: 4px; }
    .date-nav {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 15px;
    }
    .date-nav button {
      padding: 10px 15px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }
    .date-nav button:hover { background: #f3f4f6; }
    .date-nav input { flex: 1; }
    .save-indicator {
      position: fixed;
      top: 70px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .save-indicator.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üöö Delivery Tracker Pro</h1>
    <span class="status online" id="statusIndicator">‚óè Online</span>
  </div>

  <div class="save-indicator" id="saveIndicator">‚úì Auto-saved</div>

  <div class="container">
    <!-- Home Tab -->
    <div id="homeTab" class="tab-content">
      <div class="card">
        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="totalDays">0</div>
            <div class="stat-label">Days Tracked</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="thisMonth">0</div>
            <div class="stat-label">This Month</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">‚Çπ<span id="monthTotal">0</span></div>
            <div class="stat-label">Total</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Track Delivery</h2>
        <div class="date-nav">
          <button onclick="changeDate(-1)">‚óÄ</button>
          <input type="date" id="selectedDate" max="" onchange="loadDateData()">
          <button onclick="changeDate(1)">‚ñ∂</button>
        </div>
        
        <div class="input-group">
          <label>
            <input type="checkbox" id="lunchCheck">
            <span>üç± Lunch (<span id="lunchVendor">Poonam Bhabhi</span>)</span>
          </label>
        </div>
        
        <div class="input-group">
          <label>
            <input type="checkbox" id="dinnerCheck">
            <span>üçΩÔ∏è Dinner (<span id="dinnerVendor">Neetu Bhabhi</span>)</span>
          </label>
        </div>
        
        <div class="input-group">
          <label>
            <input type="checkbox" id="milkCheck">
            <span>ü•õ Milk (<span id="milkVendor">Vishal Bhaiya</span>)</span>
          </label>
        </div>

        <button class="btn btn-primary" onclick="saveDelivery()">üíæ Submit & Save</button>

        <div style="font-size: 12px; color: #6b7280; text-align: center; margin-top: 10px;">
          Last saved: <span id="lastSaved">Never</span>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div id="reportsTab" class="tab-content hidden">
      <div class="card">
        <h2>Generate Reports</h2>
        <input type="month" id="reportMonth" onchange="updateReport()">
        
        <div class="summary">
          <h3>Monthly Summary</h3>
          <p style="font-size: 14px;">Lunch: <span id="lunchTotal">0</span> √ó ‚Çπ<span id="lunchRate">100</span> = ‚Çπ<span id="lunchAmount">0</span></p>
          <p style="font-size: 14px;">Dinner: <span id="dinnerTotal">0</span> √ó ‚Çπ<span id="dinnerRate">150</span> = ‚Çπ<span id="dinnerAmount">0</span></p>
          <p style="font-size: 14px;">Milk: <span id="milkTotal">0</span> √ó ‚Çπ<span id="milkRate">16</span> = ‚Çπ<span id="milkAmount">0</span></p>
          <div class="total">‚Çπ<span id="grandTotal">0</span></div>
        </div>

        <h3 style="margin: 15px 0 10px 0; font-size: 15px;">Select Reports:</h3>
        
        <div class="input-group">
          <label>
            <input type="checkbox" id="reportLunch" onchange="handleReportSelection()">
            <span>üç± Lunch Only</span>
          </label>
        </div>
        
        <div class="input-group">
          <label>
            <input type="checkbox" id="reportDinner" onchange="handleReportSelection()">
            <span>üçΩÔ∏è Dinner Only</span>
          </label>
        </div>
        
        <div class="input-group">
          <label>
            <input type="checkbox" id="reportMilk" onchange="handleReportSelection()">
            <span>ü•õ Milk Only</span>
          </label>
        </div>
        
        <div class="input-group" style="border-top: 2px solid #e5e7eb; padding-top: 10px;">
          <label>
            <input type="checkbox" id="reportCombined" onchange="handleReportSelection()">
            <span>üìä Combined (All 3 Items)</span>
          </label>
        </div>

        <button class="btn btn-success" onclick="generateSelectedReports()">üìä Download Reports</button>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analyticsTab" class="tab-content hidden">
      <div class="card">
        <h2>Delivery History</h2>
        <input type="month" id="analyticsMonth" onchange="updateHistory()">
        <div id="historyTable"></div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settingsTab" class="tab-content hidden">
      <div class="card">
        <div id="alertBox" class="alert" style="display:none;"></div>

        <h2>Storage Health</h2>
        <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px;">
          <p>üìä Data: <strong><span id="storageSize">0</span> KB</strong> used</p>
          <p>üíæ Entries: <strong><span id="entryCount">0</span> days</strong></p>
          <p>üïê Last Backup: <strong><span id="lastBackup">Never</span></strong></p>
        </div>

        <button class="btn btn-warning" onclick="tryRecovery()">üîç Auto-Recover Lost Data</button>

        <h2 style="margin-top: 20px;">Rates (‚Çπ/delivery)</h2>
        <div class="settings-row">
          <label>üç± Lunch:</label>
          <input type="number" id="lunchRateInput" value="100" style="width: 100px;" onchange="saveSettings()">
        </div>
        <div class="settings-row">
          <label>üçΩÔ∏è Dinner:</label>
          <input type="number" id="dinnerRateInput" value="150" style="width: 100px;" onchange="saveSettings()">
        </div>
        <div class="settings-row">
          <label>ü•õ Milk:</label>
          <input type="number" id="milkRateInput" value="16" style="width: 100px;" onchange="saveSettings()">
        </div>

        <h2 style="margin-top: 20px;">Vendors</h2>
        <div class="settings-row">
          <label>üç± Lunch:</label>
          <input type="text" id="lunchVendorInput" value="Poonam Bhabhi" style="width: 180px;" onchange="saveSettings()">
        </div>
        <div class="settings-row">
          <label>üçΩÔ∏è Dinner:</label>
          <input type="text" id="dinnerVendorInput" value="Neetu Bhabhi" style="width: 180px;" onchange="saveSettings()">
        </div>
        <div class="settings-row">
          <label>ü•õ Milk:</label>
          <input type="text" id="milkVendorInput" value="Vishal Bhaiya" style="width: 180px;" onchange="saveSettings()">
        </div>

        <h2 style="margin-top: 20px;">Backup & Recovery</h2>
        <button class="btn btn-success" onclick="exportBackup()">üì• Export Backup</button>
        <label class="btn btn-primary" style="display: block; text-align: center;">
          üì§ Import Backup
          <input type="file" accept=".json" onchange="importBackup(event)" style="display: none;">
        </label>
        <button class="btn btn-secondary" onclick="autoBackup()">üíæ Create Auto-Backup Now</button>
        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
      </div>
    </div>
  </div>

  <div class="nav">
    <button class="active" onclick="showTab('home')">üè† Home</button>
    <button onclick="showTab('reports')">üìä Reports</button>
    <button onclick="showTab('analytics')">üìà Analytics</button>
    <button onclick="showTab('settings')">‚öôÔ∏è Settings</button>
  </div>

  <script>
    let deliveries = {};
    let settings = {
      rates: { lunch: 100, dinner: 150, milk: 16 },
      vendors: { lunch: 'Poonam Bhabhi', dinner: 'Neetu Bhabhi', milk: 'Vishal Bhaiya' }
    };
    let saveTimeout;

    window.onload = function() {
      initApp();
      checkOnlineStatus();
      setInterval(checkOnlineStatus, 5000);
      setInterval(autoBackup, 3600000); // Auto-backup every hour
    };

    function initApp() {
      loadData();
      document.getElementById('selectedDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('selectedDate').max = new Date().toISOString().split('T')[0];
      document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
      document.getElementById('analyticsMonth').value = new Date().toISOString().slice(0, 7);
      loadDateData();
      updateAllStats();
    }

    function loadData() {
      try {
        // Try multiple storage locations
        let loaded = false;
        
        const primary = localStorage.getItem('deliveryProV2');
        if (primary) {
          const data = JSON.parse(primary);
          if (data.deliveries && Object.keys(data.deliveries).length > 0) {
            deliveries = data.deliveries;
            settings = data.settings || settings;
            loaded = true;
            console.log('‚úì Loaded from primary storage');
          }
        }
        
        if (!loaded) {
          const backup = localStorage.getItem('deliveryProBackup');
          if (backup) {
            const data = JSON.parse(backup);
            if (data.deliveries && Object.keys(data.deliveries).length > 0) {
              deliveries = data.deliveries;
              settings = data.settings || settings;
              loaded = true;
              showAlert('Data recovered from backup!', 'success');
            }
          }
        }
        
        // Update UI with settings
        document.getElementById('lunchRateInput').value = settings.rates.lunch;
        document.getElementById('dinnerRateInput').value = settings.rates.dinner;
        document.getElementById('milkRateInput').value = settings.rates.milk;
        document.getElementById('lunchVendorInput').value = settings.vendors.lunch;
        document.getElementById('dinnerVendorInput').value = settings.vendors.dinner;
        document.getElementById('milkVendorInput').value = settings.vendors.milk;
        updateVendorNames();
        
        if (loaded) {
          const lastSave = localStorage.getItem('lastSaveTime');
          if (lastSave) {
            const date = new Date(parseInt(lastSave));
            document.getElementById('lastSaved').textContent = date.toLocaleString();
          }
        }
      } catch (e) {
        console.error('Load error:', e);
        showAlert('Error loading data: ' + e.message, 'error');
      }
    }

    function saveData() {
      try {
        const data = { 
          deliveries, 
          settings, 
          timestamp: Date.now(),
          version: 2 
        };
        
        // Save to multiple locations
        localStorage.setItem('deliveryProV2', JSON.stringify(data));
        localStorage.setItem('deliveryProBackup', JSON.stringify(data));
        localStorage.setItem('lastSaveTime', Date.now().toString());
        
        // Show save indicator
        const indicator = document.getElementById('saveIndicator');
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 2000);
        
        // Update last saved time
        document.getElementById('lastSaved').textContent = new Date().toLocaleTimeString();
        
        console.log('‚úì Data saved successfully');
      } catch (e) {
        console.error('Save error:', e);
        if (e.name === 'QuotaExceededError') {
          showAlert('Storage full! Export backup and clear old data.', 'error');
        }
      }
    }

    function saveDelivery() {
      const date = document.getElementById('selectedDate').value;
      deliveries[date] = {
        lunch: document.getElementById('lunchCheck').checked,
        dinner: document.getElementById('dinnerCheck').checked,
        milk: document.getElementById('milkCheck').checked
      };
      saveData();
      updateAllStats();
      showAlert('‚úì Delivery saved successfully!', 'success');
    }

    function autoSave() {
      // Removed - manual save only via Submit button
    }

    function loadDateData() {
      const date = document.getElementById('selectedDate').value;
      const data = deliveries[date] || {};
      document.getElementById('lunchCheck').checked = data.lunch || false;
      document.getElementById('dinnerCheck').checked = data.dinner || false;
      document.getElementById('milkCheck').checked = data.milk || false;
    }

    function changeDate(days) {
      const input = document.getElementById('selectedDate');
      const date = new Date(input.value);
      date.setDate(date.getDate() + days);
      const newDate = date.toISOString().split('T')[0];
      const today = new Date().toISOString().split('T')[0];
      if (newDate <= today) {
        input.value = newDate;
        loadDateData();
      }
    }

    function saveSettings() {
      settings.rates.lunch = Number(document.getElementById('lunchRateInput').value);
      settings.rates.dinner = Number(document.getElementById('dinnerRateInput').value);
      settings.rates.milk = Number(document.getElementById('milkRateInput').value);
      settings.vendors.lunch = document.getElementById('lunchVendorInput').value;
      settings.vendors.dinner = document.getElementById('dinnerVendorInput').value;
      settings.vendors.milk = document.getElementById('milkVendorInput').value;
      
      updateVendorNames();
      saveData();
      showAlert('Settings saved!', 'success');
      updateAllStats();
    }

    function updateVendorNames() {
      document.getElementById('lunchVendor').textContent = settings.vendors.lunch;
      document.getElementById('dinnerVendor').textContent = settings.vendors.dinner;
      document.getElementById('milkVendor').textContent = settings.vendors.milk;
    }

    function updateAllStats() {
      // Update home stats
      document.getElementById('totalDays').textContent = Object.keys(deliveries).length;
      
      const month = new Date().toISOString().slice(0, 7);
      const monthData = Object.keys(deliveries).filter(d => d.startsWith(month));
      document.getElementById('thisMonth').textContent = monthData.length;
      
      // Calculate month total
      let totals = { lunch: 0, dinner: 0, milk: 0 };
      monthData.forEach(date => {
        const data = deliveries[date];
        if (data.lunch) totals.lunch++;
        if (data.dinner) totals.dinner++;
        if (data.milk) totals.milk++;
      });
      const total = (totals.lunch * settings.rates.lunch) + (totals.dinner * settings.rates.dinner) + (totals.milk * settings.rates.milk);
      document.getElementById('monthTotal').textContent = total;
      
      // Update storage stats
      const dataSize = JSON.stringify({deliveries, settings}).length;
      document.getElementById('storageSize').textContent = (dataSize / 1024).toFixed(2);
      document.getElementById('entryCount').textContent = Object.keys(deliveries).length;
      
      const lastBackupTime = localStorage.getItem('lastBackupTime');
      if (lastBackupTime) {
        const date = new Date(parseInt(lastBackupTime));
        document.getElementById('lastBackup').textContent = date.toLocaleDateString();
      }
      
      updateReport();
    }

    function updateReport() {
      const month = document.getElementById('reportMonth').value;
      const [year, m] = month.split('-').map(Number);
      const days = new Date(year, m, 0).getDate();
      
      let totals = { lunch: 0, dinner: 0, milk: 0 };
      
      for (let d = 1; d <= days; d++) {
        const date = `${month}-${String(d).padStart(2, '0')}`;
        const data = deliveries[date] || {};
        if (data.lunch) totals.lunch++;
        if (data.dinner) totals.dinner++;
        if (data.milk) totals.milk++;
      }
      
      document.getElementById('lunchTotal').textContent = totals.lunch;
      document.getElementById('dinnerTotal').textContent = totals.dinner;
      document.getElementById('milkTotal').textContent = totals.milk;
      document.getElementById('lunchRate').textContent = settings.rates.lunch;
      document.getElementById('dinnerRate').textContent = settings.rates.dinner;
      document.getElementById('milkRate').textContent = settings.rates.milk;
      
      const amounts = {
        lunch: totals.lunch * settings.rates.lunch,
        dinner: totals.dinner * settings.rates.dinner,
        milk: totals.milk * settings.rates.milk
      };
      
      document.getElementById('lunchAmount').textContent = amounts.lunch;
      document.getElementById('dinnerAmount').textContent = amounts.dinner;
      document.getElementById('milkAmount').textContent = amounts.milk;
      document.getElementById('grandTotal').textContent = amounts.lunch + amounts.dinner + amounts.milk;
    }

    function updateHistory() {
      const month = document.getElementById('analyticsMonth').value;
      const [year, m] = month.split('-').map(Number);
      const days = new Date(year, m, 0).getDate();
      
      let html = '<table><thead><tr><th>Date</th><th>L</th><th>D</th><th>M</th></tr></thead><tbody>';
      
      for (let d = 1; d <= days; d++) {
        const date = `${month}-${String(d).padStart(2, '0')}`;
        const data = deliveries[date] || {};
        const dateObj = new Date(date);
        const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short', day: '2-digit', month: 'short' });
        
        html += `<tr><td>${dayName}</td><td style="text-align:center;">${data.lunch ? '‚úì' : '-'}</td><td style="text-align:center;">${data.dinner ? '‚úì' : '-'}</td><td style="text-align:center;">${data.milk ? '‚úì' : '-'}</td></tr>`;
      }
      
      html += '</tbody></table>';
      document.getElementById('historyTable').innerHTML = html;
    }

    function handleReportSelection() {
      const combined = document.getElementById('reportCombined');
      const lunch = document.getElementById('reportLunch');
      const dinner = document.getElementById('reportDinner');
      const milk = document.getElementById('reportMilk');
      
      if (combined.checked) {
        lunch.checked = false;
        dinner.checked = false;
        milk.checked = false;
        lunch.disabled = true;
        dinner.disabled = true;
        milk.disabled = true;
      } else {
        lunch.disabled = false;
        dinner.disabled = false;
        milk.disabled = false;
      }
    }

    function generateSelectedReports() {
      const selected = [];
      const isCombined = document.getElementById('reportCombined').checked;
      
      if (isCombined) {
        selected.push('combined');
      } else {
        if (document.getElementById('reportLunch').checked) selected.push('lunch');
        if (document.getElementById('reportDinner').checked) selected.push('dinner');
        if (document.getElementById('reportMilk').checked) selected.push('milk');
      }
      
      if (selected.length === 0) {
        showAlert('Please select at least one report!', 'error');
        return;
      }
      
      const month = document.getElementById('reportMonth').value;
      const [year, m] = month.split('-').map(Number);
      const monthName = new Date(year, m - 1).toLocaleString('default', { month: 'long' });
      const days = new Date(year, m, 0).getDate();
      
      selected.forEach(type => {
        let totals = { lunch: 0, dinner: 0, milk: 0 };
        let rows = '';
        
        for (let d = 1; d <= days; d++) {
          const date = `${month}-${String(d).padStart(2, '0')}`;
          const data = deliveries[date] || {};
          const dateObj = new Date(date);
          const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short', day: '2-digit', month: 'short' });
          
          if (data.lunch) totals.lunch++;
          if (data.dinner) totals.dinner++;
          if (data.milk) totals.milk++;
          
          if (type === 'combined') {
            rows += `<tr><td><b>${dayName}</b></td><td class="${data.lunch?'yes':'no'}">${data.lunch?'‚úì Yes':'‚úó No'}</td><td class="${data.dinner?'yes':'no'}">${data.dinner?'‚úì Yes':'‚úó No'}</td><td class="${data.milk?'yes':'no'}">${data.milk?'‚úì Yes':'‚úó No'}</td></tr>`;
          } else {
            rows += `<tr><td><b>${dayName}</b></td><td class="${data[type]?'yes':'no'}">${data[type]?'‚úì Yes':'‚úó No'}</td></tr>`;
          }
        }
        
        let html = '';
        
        if (type === 'combined') {
          const amounts = {
            lunch: totals.lunch * settings.rates.lunch,
            dinner: totals.dinner * settings.rates.dinner,
            milk: totals.milk * settings.rates.milk
          };
          const total = amounts.lunch + amounts.dinner + amounts.milk;
          
          html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Combined Report</title><style>body{font-family:Arial;max-width:800px;margin:40px auto;padding:20px;background:#f5f5f5}.box{background:white;border-radius:12px;padding:30px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}h1{color:#1f2937;text-align:center;border-bottom:3px solid #667eea;padding-bottom:20px}table{width:100%;border-collapse:collapse;margin:20px 0}th{background:#667eea;color:white;padding:12px;text-align:left}td{padding:10px;border-bottom:1px solid #e5e7eb}.yes{color:#059669;font-weight:600}.no{color:#dc2626}.summary{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:25px;border-radius:10px;margin-top:30px}.total{font-size:32px;font-weight:bold;text-align:center;margin-top:20px;padding-top:20px;border-top:2px solid rgba(255,255,255,0.3)}</style></head><body><div class="box"><h1>Combined Delivery Report<br><small style="color:#6b7280">${monthName} ${year}</small></h1><table><thead><tr><th>Date</th><th>Lunch</th><th>Dinner</th><th>Milk</th></tr></thead><tbody>${rows}</tbody></table><div class="summary"><h2>Summary</h2><p>Lunch: ${totals.lunch} √ó ‚Çπ${settings.rates.lunch} = ‚Çπ${amounts.lunch}</p><p>Dinner: ${totals.dinner} √ó ‚Çπ${settings.rates.dinner} = ‚Çπ${amounts.dinner}</p><p>Milk: ${totals.milk} √ó ‚Çπ${settings.rates.milk} = ‚Çπ${amounts.milk}</p><div class="total">Total: ‚Çπ${total}</div></div></div></body></html>`;
        } else {
          const itemName = type.charAt(0).toUpperCase() + type.slice(1);
          const vendor = settings.vendors[type];
          const rate = settings.rates[type];
          const amount = totals[type] * rate;
          
          html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${itemName} Report</title><style>body{font-family:Arial;max-width:800px;margin:40px auto;padding:20px;background:#f5f5f5}.box{background:white;border-radius:12px;padding:30px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}h1{color:#1f2937;text-align:center;border-bottom:3px solid #667eea;padding-bottom:20px}.info{background:#eff6ff;padding:15px;border-radius:8px;margin:20px 0;border-left:4px solid #667eea}.info p{margin:5px 0;color:#1e40af;font-weight:500}table{width:100%;border-collapse:collapse;margin:20px 0}th{background:#667eea;color:white;padding:12px;text-align:left}td{padding:10px;border-bottom:1px solid #e5e7eb}.yes{color:#059669;font-weight:600}.no{color:#dc2626}.summary{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:25px;border-radius:10px;margin-top:30px}.total{font-size:32px;font-weight:bold;text-align:center;margin-top:20px;padding-top:20px;border-top:2px solid rgba(255,255,255,0.3)}</style></head><body><div class="box"><h1>${itemName} Delivery Report<br><small style="color:#6b7280">${monthName} ${year}</small></h1><div class="info"><p><strong>Vendor:</strong> ${vendor}</p><p><strong>Rate:</strong> ‚Çπ${rate} per delivery</p></div><table><thead><tr><th>Date</th><th>Delivered</th></tr></thead><tbody>${rows}</tbody></table><div class="summary"><h2>Summary</h2><p>Total Deliveries: ${totals[type]}</p><p>Rate per Delivery: ‚Çπ${rate}</p><div class="total">Total Amount: ‚Çπ${amount}</div></div></div></body></html>`;
        }
        
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report-${type}-${month}.html`;
        a.click();
        URL.revokeObjectURL(url);
      });
      
      // Reset checkboxes
      document.getElementById('reportLunch').checked = false;
      document.getElementById('reportDinner').checked = false;
      document.getElementById('reportMilk').checked = false;
      document.getElementById('reportCombined').checked = false;
      handleReportSelection();
      
      showAlert('Reports downloaded successfully!', 'success');
    }

    function exportBackup() {
      const backup = { deliveries, settings, exportDate: new Date().toISOString(), version: 2 };
      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `delivery-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      localStorage.setItem('lastBackupTime', Date.now().toString());
      updateAllStats();
      showAlert('Backup exported successfully!', 'success');
    }

    function importBackup(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const backup = JSON.parse(e.target.result);
            if (!backup.deliveries) throw new Error('Invalid backup format');
            
            deliveries = backup.deliveries;
            settings = backup.settings || settings;
            saveData();
            loadData();
            updateAllStats();
            updateHistory();
            showAlert(`Backup restored! ${Object.keys(deliveries).length} days recovered.`, 'success');
            setTimeout(() => location.reload(), 1500);
          } catch (err) {
            showAlert('Invalid backup file: ' + err.message, 'error');
          }
        };
        reader.readAsText(file);
      }
      event.target.value = '';
    }

    function autoBackup() {
      if (Object.keys(deliveries).length > 0) {
        const backup = { deliveries, settings, autoBackup: true, timestamp: Date.now() };
        localStorage.setItem('autoBackup', JSON.stringify(backup));
        localStorage.setItem('lastBackupTime', Date.now().toString());
        updateAllStats();
        console.log('‚úì Auto-backup created');
        showAlert('Auto-backup created!', 'success');
      }
    }

    function tryRecovery() {
      try {
        const sources = [
          'deliveryProBackup',
          'autoBackup',
          'deliveryTrackerSimple',
          'deliveryData',
          'deliveryTrackerData'
        ];
        
        let recovered = null;
        let recoveredFrom = '';
        
        for (const source of sources) {
          const data = localStorage.getItem(source);
          if (data) {
            try {
              const parsed = JSON.parse(data);
              if (parsed.deliveries && Object.keys(parsed.deliveries).length > 0) {
                recovered = parsed;
                recoveredFrom = source;
                break;
              }
            } catch (e) {}
          }
        }
        
        if (recovered) {
          deliveries = recovered.deliveries;
          settings = recovered.settings || settings;
          saveData();
          loadData();
          updateAllStats();
          showAlert(`‚úì Recovered ${Object.keys(deliveries).length} days from ${recoveredFrom}!`, 'success');
          setTimeout(() => location.reload(), 2000);
        } else {
          showAlert('No recoverable data found in any storage location.', 'error');
        }
      } catch (e) {
        showAlert('Recovery failed: ' + e.message, 'error');
      }
    }

    function clearAllData() {
      if (confirm('‚ö†Ô∏è This will DELETE ALL DATA permanently. Export backup first!\n\nAre you absolutely sure?')) {
        if (confirm('Last chance! This cannot be undone. Continue?')) {
          deliveries = {};
          saveData();
          showAlert('All data cleared!', 'success');
          setTimeout(() => location.reload(), 1000);
        }
      }
    }

    function checkOnlineStatus() {
      const indicator = document.getElementById('statusIndicator');
      if (navigator.onLine) {
        indicator.className = 'status online';
        indicator.textContent = '‚óè Online';
      } else {
        indicator.className = 'status offline';
        indicator.textContent = '‚óè Offline';
      }
    }

    function showAlert(message, type) {
      const box = document.getElementById('alertBox');
      box.textContent = message;
      box.className = `alert ${type}`;
      box.style.display = 'block';
      setTimeout(() => {
        box.style.display = 'none';
      }, 5000);
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      
      document.getElementById(tab + 'Tab').classList.remove('hidden');
      event.target.classList.add('active');
      
      if (tab === 'reports') updateReport();
      if (tab === 'analytics') updateHistory();
      if (tab === 'settings') updateAllStats();
    }
  </script>
</body>
</html>
